<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Reporte FotogrÃ¡fico Witlink</title>

<style>
body{font-family:Arial;background:#f4f4f4;padding:15px}
.card{background:#fff;padding:15px;border-radius:8px;margin-top:10px}
.hidden{display:none}
li{padding:10px;border-bottom:1px solid #ddd;cursor:pointer}
li:hover{background:#eee}
button,input{width:100%;padding:12px;margin:6px 0}
.preview{width:100%;border-radius:6px;margin:6px 0}
.logo{max-width:160px}
.header{text-align:center}
canvas{display:none}
</style>
</head>

<body>

<div class="header">
  <img src="LOGO_URL_AQUI" class="logo">
</div>

<div id="vistaProyectos" class="card">
  <h3>ğŸ“ Proyectos</h3>
  <ul id="listaProyectos"></ul>
  <input id="nuevoProyecto" placeholder="Nombre del nuevo proyecto">
  <button onclick="crearProyecto()">â• Crear Proyecto</button>
</div>

<div id="vistaPostes" class="card hidden">
  <h3 id="tituloProyecto"></h3>
  <ul id="listaPostes"></ul>
  <button onclick="nuevoPoste()">â• Nuevo Poste</button>
  <button onclick="volverProyectos()">â¬… Volver</button>
</div>

<div id="vistaEditar" class="card hidden">
  <h3 id="tituloPoste"></h3>

  <img id="img1" class="preview">
  <input type="file" id="foto1" accept="image/*" capture="camera" onchange="procesar(this,1)">

  <img id="img2" class="preview">
  <input type="file" id="foto2" accept="image/*" capture="camera" onchange="procesar(this,2)">

  <img id="img3" class="preview">
  <input type="file" id="foto3" accept="image/*" capture="camera" onchange="procesar(this,3)">

  <button onclick="guardar()">ğŸ’¾ Guardar cambios</button>
  <button onclick="volverPostes()">â¬… Volver</button>
</div>

<canvas id="cv"></canvas>

<script>
const URL="https://script.google.com/macros/s/AKfycbxAX5zbvFxW9ACBhoKt9iwkZ82ZmogVOFQwY59Xr_0GsajmvO4O0IHlLQxndBc7Qojc/exec";
let proyecto="", poste="";
let lat="", lng="", fecha="";
let imgFinal=[null,null,null];

/* ===== GPS ===== */
navigator.geolocation.getCurrentPosition(p=>{
  lat=p.coords.latitude.toFixed(6);
  lng=p.coords.longitude.toFixed(6);
});
fecha=new Date().toLocaleString();

/* ===== PROYECTOS ===== */
fetch(URL+"?accion=proyectos").then(r=>r.json()).then(d=>{
  d.forEach(p=>{
    let li=document.createElement("li");
    li.innerText=p;
    li.onclick=()=>abrirProyecto(p);
    listaProyectos.appendChild(li);
  });
});

function crearProyecto(){
  const n=nuevoProyecto.value.trim();
  if(!n){alert("Ingrese nombre");return;}
  abrirProyecto(n);
}

/* ===== POSTES ===== */
function abrirProyecto(p){
  proyecto=p;
  tituloProyecto.innerText="ğŸ“‚ "+p;
  vistaProyectos.classList.add("hidden");
  vistaPostes.classList.remove("hidden");

  fetch(`${URL}?accion=postes&proyecto=${p}`).then(r=>r.json()).then(d=>{
    listaPostes.innerHTML="";
    d.forEach(x=>{
      let li=document.createElement("li");
      li.innerText=x;
      li.onclick=()=>editarPoste(x);
      listaPostes.appendChild(li);
    });
  });
}

function nuevoPoste(){
  poste="Poste "+(listaPostes.children.length+1);
  editarPoste(poste);
}

function editarPoste(p){
  poste=p;
  tituloPoste.innerText=p;
  vistaPostes.classList.add("hidden");
  vistaEditar.classList.remove("hidden");

  img1.src=`${URL}?img=poste.jpg&proyecto=${proyecto}&poste=${poste}`;
  img2.src=`${URL}?img=ferreteria.jpg&proyecto=${proyecto}&poste=${poste}`;
  img3.src=`${URL}?img=panoramica.jpg&proyecto=${proyecto}&poste=${poste}`;
}

/* ===== CANVAS ===== */
async function procesar(input,i){
  if(!input.files[0])return;
  const calle=prompt("ğŸ“Œ Nombre de la calle:");
  const file=input.files[0];
  const img=new Image();
  img.src=URL.createObjectURL(file);
  await img.decode();

  const c=cv;
  const ctx=c.getContext("2d");
  c.width=img.width;
  c.height=img.height;
  ctx.drawImage(img,0,0);

  ctx.fillStyle="rgba(0,0,0,0.6)";
  ctx.fillRect(0,c.height-140,c.width,140);

  ctx.fillStyle="#fff";
  ctx.font="24px Arial";
  ctx.fillText(`ğŸ“ ${lat}, ${lng}`,20,c.height-100);
  ctx.fillText(`ğŸ—“ ${fecha}`,20,c.height-70);
  ctx.fillText(`ğŸ“Œ ${calle}`,20,c.height-40);
  ctx.fillText(`ğŸ”¢ Poste: ${poste}`,20,c.height-10);

  imgFinal[i-1]=await new Promise(r=>c.toBlob(b=>r(b),"image/jpeg",0.8));
  document.getElementById("img"+i).src=URL.createObjectURL(imgFinal[i-1]);
}

/* ===== GUARDAR ===== */
async function guardar(){
  await fetch(URL,{
    method:"POST",
    body:JSON.stringify({
      proyecto, poste,
      foto1: imgFinal[0]?await b64(imgFinal[0]):null,
      foto2: imgFinal[1]?await b64(imgFinal[1]):null,
      foto3: imgFinal[2]?await b64(imgFinal[2]):null
    })
  });
  alert("âœ… Fotos guardadas con marca visible");
  volverPostes();
}

/* ===== UTIL ===== */
function b64(f){
  return new Promise(r=>{
    const fr=new FileReader();
    fr.onload=()=>r(fr.result.split(",")[1]);
    fr.readAsDataURL(f);
  });
}
function volverPostes(){
  vistaEditar.classList.add("hidden");
  vistaPostes.classList.remove("hidden");
}
function volverProyectos(){
  vistaPostes.classList.add("hidden");
  vistaProyectos.classList.remove("hidden");
}
</script>

</body>
</html>
