<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Reporte FotogrÃ¡fico Witlink</title>

<style>
body{font-family:Arial;background:#f4f4f4;padding:15px}
.card{background:#fff;padding:15px;border-radius:8px;margin-top:10px}
.hidden{display:none}
li{padding:10px;border-bottom:1px solid #ddd;cursor:pointer}
li:hover{background:#eee}
button,input{width:100%;padding:12px;margin:6px 0}
.preview{width:100%;border-radius:6px;margin:6px 0}
.logo{max-width:160px}
.header{text-align:center}
</style>
</head>

<body>

<div class="header">
  <img src="https://drive.google.com/file/d/1Qzr0PMX2Fp1388snZ4ix_AoeM8AmuVPH/view?usp=drive_link" class="logo">
</div>

<div id="vistaProyectos" class="card">
  <h3>ğŸ“ Proyectos</h3>
  <ul id="listaProyectos"></ul>
</div>

<div id="vistaPostes" class="card hidden">
  <h3 id="tituloProyecto"></h3>
  <ul id="listaPostes"></ul>
  <button onclick="volverProyectos()">â¬… Volver</button>
</div>

<div id="vistaEditar" class="card hidden">
  <h3 id="tituloPoste"></h3>

  <img id="img1" class="preview">
  <input type="file" id="foto1" accept="image/*" capture="camera">

  <img id="img2" class="preview">
  <input type="file" id="foto2" accept="image/*" capture="camera">

  <img id="img3" class="preview">
  <input type="file" id="foto3" accept="image/*" capture="camera">

  <button onclick="guardar()">ğŸ’¾ Guardar cambios</button>
  <button onclick="volverPostes()">â¬… Volver</button>
</div>

<script>
const URL="https://script.google.com/macros/s/AKfycbwvE5tLLfWAZNEeBBvHJ2PK903CSgWoGjeWdwa017SWKWSAUTEbH1jeL9zAHVF4sSEQ/exec";
let proyecto="", poste="";

/* ===== CARGAR PROYECTOS ===== */
fetch(URL+"?accion=proyectos").then(r=>r.json()).then(d=>{
  d.forEach(p=>{
    let li=document.createElement("li");
    li.innerText=p;
    li.onclick=()=>abrirProyecto(p);
    listaProyectos.appendChild(li);
  });
});

/* ===== PROYECTO ===== */
function abrirProyecto(p){
  proyecto=p;
  tituloProyecto.innerText="ğŸ“‚ "+p;
  vistaProyectos.classList.add("hidden");
  vistaPostes.classList.remove("hidden");

  fetch(`${URL}?accion=postes&proyecto=${p}`).then(r=>r.json()).then(d=>{
    listaPostes.innerHTML="";
    d.forEach(x=>{
      let li=document.createElement("li");
      li.innerText=x;
      li.onclick=()=>editarPoste(x);
      listaPostes.appendChild(li);
    });
  });
}

/* ===== POSTE ===== */
function editarPoste(p){
  poste=p;
  tituloPoste.innerText=p;
  vistaPostes.classList.add("hidden");
  vistaEditar.classList.remove("hidden");

  img1.src=`${URL}?img=poste.jpg&proyecto=${proyecto}&poste=${poste}`;
  img2.src=`${URL}?img=ferreteria.jpg&proyecto=${proyecto}&poste=${poste}`;
  img3.src=`${URL}?img=panoramica.jpg&proyecto=${proyecto}&poste=${poste}`;
}

/* ===== GUARDAR ===== */
async function guardar(){
  await fetch(URL,{
    method:"POST",
    body:JSON.stringify({
      proyecto, poste,
      foto1: foto1.files[0] ? await b64(foto1.files[0]) : null,
      foto2: foto2.files[0] ? await b64(foto2.files[0]) : null,
      foto3: foto3.files[0] ? await b64(foto3.files[0]) : null
    })
  });
  alert("Fotos actualizadas");
}

/* ===== VOLVER ===== */
function volverPostes(){
  vistaEditar.classList.add("hidden");
  vistaPostes.classList.remove("hidden");
}
function volverProyectos(){
  vistaPostes.classList.add("hidden");
  vistaProyectos.classList.remove("hidden");
}

/* ===== UTIL ===== */
function b64(f){
  return new Promise(r=>{
    let fr=new FileReader();
    fr.onload=()=>r(fr.result.split(",")[1]);
    fr.readAsDataURL(f);
  });
}
</script>

</body>
</html>
