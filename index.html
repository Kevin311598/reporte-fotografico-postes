<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Reporte Fotogr√°fico Postes</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 15px;
      background: #f4f4f4;
    }
    input, button {
      width: 100%;
      margin: 8px 0;
      padding: 10px;
      font-size: 16px;
    }
    label {
      font-weight: bold;
      margin-top: 10px;
      display: block;
    }
    button {
      background: #2e7d32;
      color: white;
      border: none;
      border-radius: 5px;
    }
    #gps, #fecha {
      margin: 8px 0;
      font-weight: bold;
    }
  </style>
</head>
<body>

<h2>üì∏ Reporte Fotogr√°fico</h2>

<p id="fecha">üìÖ Fecha:</p>
<p id="gps">üìç Obteniendo coordenadas...</p>

<input id="proyecto" placeholder="Proyecto" required>
<input id="poste" placeholder="N√∫mero de poste" required>

<label>1Ô∏è‚É£ N√∫mero de poste</label>
<input type="file" id="foto1" accept="image/*" capture="camera" required>

<label>2Ô∏è‚É£ Ferreter√≠a del poste</label>
<input type="file" id="foto2" accept="image/*" capture="camera" required>

<label>3Ô∏è‚É£ Vista panor√°mica</label>
<input type="file" id="foto3" accept="image/*" capture="camera" required>

<button onclick="enviar()">Guardar fotos</button>

<script>
// ===================== CONFIGURA TU BACKEND =====================
const URL_BACKEND = "https://kevin311598.github.io/reporte-fotografico-postes/";

// ===================== FECHA AUTOM√ÅTICA =====================
const fechaHoy = new Date().toISOString().slice(0,10);
document.getElementById("fecha").innerText = "üìÖ Fecha: " + fechaHoy;

// ===================== GPS AUTOM√ÅTICO =====================
let coords = { lat: null, lon: null };

function obtenerGPS() {
  if (!navigator.geolocation) {
    alert("Geolocalizaci√≥n no disponible en este navegador.");
    return;
  }

  navigator.geolocation.getCurrentPosition(
    (pos) => {
      coords.lat = pos.coords.latitude.toFixed(6);
      coords.lon = pos.coords.longitude.toFixed(6);
      document.getElementById("gps").innerText = `üìç Coordenadas: ${coords.lat}, ${coords.lon}`;
    },
    (err) => {
      alert("Error obteniendo GPS: " + err.message);
    },
    { enableHighAccuracy: true }
  );
}
window.onload = () => { obtenerGPS(); };

// ===================== CONVERTIR A BASE64 =====================
function toBase64(file) {
  return new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.onload = () => resolve(reader.result.split(',')[1]);
    reader.onerror = reject;
    reader.readAsDataURL(file);
  });
}

// ===================== MARCA DE AGUA =====================
function agregarMarcaAgua(file, texto, callback) {
  const reader = new FileReader();

  reader.onload = function(e) {
    const img = new Image();
    img.onload = function() {
      const canvas = document.createElement("canvas");
      canvas.width = img.width;
      canvas.height = img.height;

      const ctx = canvas.getContext("2d");
      ctx.drawImage(img, 0, 0);

      ctx.font = "30px Arial";
      ctx.fillStyle = "rgba(255, 255, 255, 0.7)";
      ctx.strokeStyle = "rgba(0, 0, 0, 0.7)";
      ctx.lineWidth = 2;

      const lines = texto.split('\n');
      for(let i=0; i<lines.length; i++) {
        ctx.strokeText(lines[i], 10, 40 + i*35);
        ctx.fillText(lines[i], 10, 40 + i*35);
      }

      canvas.toBlob(function(blob) {
        const reader2 = new FileReader();
        reader2.onloadend = function() {
          callback(reader2.result.split(',')[1]);
        };
        reader2.readAsDataURL(blob);
      }, "image/jpeg", 0.9);
    };
    img.src = e.target.result;
  };

  reader.readAsDataURL(file);
}

// ===================== ENVIAR DATOS =====================
async function enviar() {
  const boton = document.querySelector("button");
  boton.disabled = true;
  boton.innerText = "Subiendo...";

  const proyecto = document.getElementById("proyecto").value;
  const poste = document.getElementById("poste").value;

  if (!proyecto || !poste) {
    alert("Completa proyecto y poste");
    boton.disabled = false;
    boton.innerText = "Guardar fotos";
    return;
  }

  const f1 = document.getElementById("foto1").files[0];
  const f2 = document.getElementById("foto2").files[0];
  const f3 = document.getElementById("foto3").files[0];

  if (!f1 || !f2 || !f3) {
    alert("Debes tomar las 3 fotos");
    boton.disabled = false;
    boton.innerText = "Guardar fotos";
    return;
  }

  const textoMarca = `Fecha: ${fechaHoy}\nPoste: ${poste}\nGPS: ${coords.lat},${coords.lon}`;

  // Crear fotos con marca de agua
  const f1_marcada = await new Promise(resolve => agregarMarcaAgua(f1, textoMarca, resolve));
  const f2_marcada = await new Promise(resolve => agregarMarcaAgua(f2, textoMarca, resolve));
  const f3_marcada = await new Promise(resolve => agregarMarcaAgua(f3, textoMarca, resolve));

  const data = {
    proyecto,
    poste,
    lat: coords.lat,
    lon: coords.lon,
    foto1: f1_marcada,
    foto2: f2_marcada,
    foto3: f3_marcada
  };

  try {
    await fetch(URL_BACKEND, {
      method: "POST",
      body: JSON.stringify(data)
    });

    alert("‚úÖ Fotos guardadas correctamente");
    document.getElementById("proyecto").value = "";
    document.getElementById("poste").value = "";
    document.getElementById("foto1").value = "";
    document.getElementById("foto2").value = "";
    document.getElementById("foto3").value = "";
    obtenerGPS(); // refresca coordenadas para la siguiente toma
  } catch {
    alert("‚ùå Error al subir");
  }

  boton.disabled = false;
  boton.innerText = "Guardar fotos";
}
</script>

</body>
</html>
