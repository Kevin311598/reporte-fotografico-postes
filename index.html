<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Reporte Fotogr√°fico Postes</title>

<style>
body {
  font-family: Arial, sans-serif;
  padding: 15px;
  background: #f4f4f4;
}
input, button {
  width: 100%;
  margin: 8px 0;
  padding: 12px;
  font-size: 16px;
}
label { font-weight: bold; }
button {
  border: none;
  border-radius: 6px;
}
#guardar { background: #2e7d32; color: white; }
#nuevo { background: #0277bd; color: white; }
.info { font-weight: bold; margin: 6px 0; }
</style>
</head>

<body>

<h2>üì∏ Reporte Fotogr√°fico</h2>

<p class="info" id="fecha"></p>
<p class="info" id="gps">üìç Obteniendo GPS‚Ä¶</p>

<input id="proyecto" placeholder="Proyecto">
<input id="poste" placeholder="N√∫mero de poste">

<label>1Ô∏è‚É£ N√∫mero de poste</label>
<input type="file" id="foto1" accept="image/*" capture="camera">

<label>2Ô∏è‚É£ Ferreter√≠a del poste</label>
<input type="file" id="foto2" accept="image/*" capture="camera">

<label>3Ô∏è‚É£ Vista panor√°mica</label>
<input type="file" id="foto3" accept="image/*" capture="camera">

<button id="guardar">üíæ Guardar poste</button>
<button id="nuevo">‚ûï Agregar otro poste</button>

<script>
// ================= CONFIG =================
const URL_BACKEND = "https://script.google.com/macros/s/AKfycbyCqRlwuBtExpNRu2yKRFPeT8VSxgMDCpu1p88MtLo9mdqrYsZ-yQELZpYu6u0oSlpO/exec";

// ================= REFERENCIAS =================
const proyectoInput = document.getElementById("proyecto");
const posteInput = document.getElementById("poste");
const foto1Input = document.getElementById("foto1");
const foto2Input = document.getElementById("foto2");
const foto3Input = document.getElementById("foto3");
const guardarBtn = document.getElementById("guardar");
const nuevoBtn = document.getElementById("nuevo");
const gpsText = document.getElementById("gps");

// ================= FECHA =================
const fechaHoy = new Date().toISOString().slice(0,10);
document.getElementById("fecha").innerText = "üìÖ Fecha: " + fechaHoy;

// ================= GPS (UNA VEZ) =================
let coords = { lat: "", lon: "" };

navigator.geolocation.getCurrentPosition(
  pos => {
    coords.lat = pos.coords.latitude.toFixed(6);
    coords.lon = pos.coords.longitude.toFixed(6);
    gpsText.innerText = `üìç GPS: ${coords.lat}, ${coords.lon}`;
  },
  () => gpsText.innerText = "‚ùå GPS no disponible",
  { enableHighAccuracy: false, timeout: 5000 }
);

// ================= IMAGEN OPTIMIZADA =================
function procesarImagen(file) {
  return new Promise(resolve => {
    const img = new Image();
    const reader = new FileReader();

    reader.onload = e => img.src = e.target.result;

    img.onload = () => {
      const MAX = 1280;
      let w = img.width;
      let h = img.height;

      if (w > MAX) {
        h *= MAX / w;
        w = MAX;
      }

      const canvas = document.createElement("canvas");
      canvas.width = w;
      canvas.height = h;
      const ctx = canvas.getContext("2d");

      ctx.drawImage(img, 0, 0, w, h);

      ctx.fillStyle = "rgba(0,0,0,0.6)";
      ctx.fillRect(0, h - 120, w, 120);

      ctx.fillStyle = "white";
      ctx.font = "bold 28px Arial";
      ctx.fillText(`Fecha: ${fechaHoy}`, 20, h - 80);
      ctx.fillText(`Poste: ${posteInput.value}`, 20, h - 45);
      ctx.fillText(`GPS: ${coords.lat}, ${coords.lon}`, 20, h - 10);

      canvas.toBlob(blob => {
        const r2 = new FileReader();
        r2.onloadend = () => resolve(r2.result.split(",")[1]);
        r2.readAsDataURL(blob);
      }, "image/jpeg", 0.8);
    };

    reader.readAsDataURL(file);
  });
}

// ================= GUARDAR =================
guardarBtn.onclick = async () => {
  if (!coords.lat) {
    alert("Espera a que el GPS cargue");
    return;
  }

  if (!proyectoInput.value || !posteInput.value ||
      !foto1Input.files[0] || !foto2Input.files[0] || !foto3Input.files[0]) {
    alert("Completa proyecto, poste y las 3 fotos");
    return;
  }

  guardarBtn.disabled = true;
  guardarBtn.innerText = "Subiendo...";

  try {
    const f1 = await procesarImagen(foto1Input.files[0]);
    const f2 = await procesarImagen(foto2Input.files[0]);
    const f3 = await procesarImagen(foto3Input.files[0]);

    await fetch(URL_BACKEND, {
      method: "POST",
      body: JSON.stringify({
        proyecto: proyectoInput.value,
        poste: posteInput.value,
        lat: coords.lat,
        lon: coords.lon,
        foto1: f1,
        foto2: f2,
        foto3: f3
      })
    });

    alert("‚úÖ Poste guardado correctamente");
  } catch (e) {
    alert("‚ùå Error al subir");
  }

  guardarBtn.disabled = false;
  guardarBtn.innerText = "üíæ Guardar poste";
};

// ================= NUEVO POSTE =================
nuevoBtn.onclick = () => {
  posteInput.value = "";
  foto1Input.value = "";
  foto2Input.value = "";
  foto3Input.value = "";
  posteInput.focus();
};
</script>

</body>
</html>
