<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Reporte Fotogr√°fico Postes</title>

<style>
body {
  font-family: Arial, sans-serif;
  padding: 15px;
  background: #f4f4f4;
}
input, button {
  width: 100%;
  margin: 8px 0;
  padding: 12px;
  font-size: 16px;
}
label {
  font-weight: bold;
}
button {
  border: none;
  border-radius: 6px;
}
#guardar {
  background: #2e7d32;
  color: white;
}
#nuevo {
  background: #0277bd;
  color: white;
}
.info {
  font-weight: bold;
  margin: 6px 0;
}
</style>
</head>

<body>

<h2>üì∏ Reporte Fotogr√°fico</h2>

<p class="info" id="fecha"></p>
<p class="info" id="gps">üìç Obteniendo GPS‚Ä¶</p>

<input id="proyecto" placeholder="Proyecto" required>
<input id="poste" placeholder="N√∫mero de poste" required>

<label>1Ô∏è‚É£ N√∫mero de poste</label>
<input type="file" id="foto1" accept="image/*" capture="camera">

<label>2Ô∏è‚É£ Ferreter√≠a del poste</label>
<input type="file" id="foto2" accept="image/*" capture="camera">

<label>3Ô∏è‚É£ Vista panor√°mica</label>
<input type="file" id="foto3" accept="image/*" capture="camera">

<button id="guardar" onclick="enviar()">üíæ Guardar poste</button>
<button id="nuevo" onclick="nuevoPoste()">‚ûï Agregar otro poste</button>

<script>
// ================= CONFIG =================
const URL_BACKEND = "https://kevin311598.github.io/reporte-fotografico-postes/";

// ================= FECHA =================
const fechaHoy = new Date().toISOString().slice(0,10);
document.getElementById("fecha").innerText = "üìÖ Fecha: " + fechaHoy;

// ================= GPS (UNA SOLA VEZ) =================
let coords = { lat: "", lon: "" };

navigator.geolocation.getCurrentPosition(
  pos => {
    coords.lat = pos.coords.latitude.toFixed(6);
    coords.lon = pos.coords.longitude.toFixed(6);
    gps.innerText = `üìç GPS: ${coords.lat}, ${coords.lon}`;
  },
  () => gps.innerText = "‚ùå GPS no disponible",
  { enableHighAccuracy: false, timeout: 5000 }
);

// ================= PROCESAR IMAGEN (R√ÅPIDO) =================
function procesarImagen(file) {
  return new Promise(resolve => {
    const img = new Image();
    const reader = new FileReader();

    reader.onload = e => img.src = e.target.result;

    img.onload = () => {
      const MAX = 1280; // CLAVE PARA VELOCIDAD
      let w = img.width;
      let h = img.height;

      if (w > MAX) {
        h *= MAX / w;
        w = MAX;
      }

      const canvas = document.createElement("canvas");
      canvas.width = w;
      canvas.height = h;
      const ctx = canvas.getContext("2d");

      ctx.drawImage(img, 0, 0, w, h);

      // Marca de agua optimizada
      ctx.fillStyle = "rgba(0,0,0,0.6)";
      ctx.fillRect(0, h - 120, w, 120);

      ctx.fillStyle = "white";
      ctx.font = "bold 28px Arial";
      ctx.fillText(`Fecha: ${fechaHoy}`, 20, h - 80);
      ctx.fillText(`Poste: ${poste.value}`, 20, h - 45);
      ctx.fillText(`GPS: ${coords.lat}, ${coords.lon}`, 20, h - 10);

      canvas.toBlob(blob => {
        const r2 = new FileReader();
        r2.onloadend = () => resolve(r2.result.split(",")[1]);
        r2.readAsDataURL(blob);
      }, "image/jpeg", 0.8); // compresi√≥n
    };

    reader.readAsDataURL(file);
  });
}

// ================= ENVIAR =================
async function enviar() {
  if (!coords.lat) {
    alert("Espera a que el GPS cargue");
    return;
  }

  const proyectoVal = proyecto.value;
  const posteVal = poste.value;

  if (!proyectoVal || !posteVal || !foto1.files[0] || !foto2.files[0] || !foto3.files[0]) {
    alert("Completa todos los campos y fotos");
    return;
  }

  guardar.disabled = true;
  guardar.innerText = "Subiendo...";

  const f1 = await procesarImagen(foto1.files[0]);
  const f2 = await procesarImagen(foto2.files[0]);
  const f3 = await procesarImagen(foto3.files[0]);

  await fetch(URL_BACKEND, {
    method: "POST",
    body: JSON.stringify({
      proyecto: proyectoVal,
      poste: posteVal,
      lat: coords.lat,
      lon: coords.lon,
      foto1: f1,
      foto2: f2,
      foto3: f3
    })
  });

  alert("‚úÖ Poste guardado correctamente");

  guardar.disabled = false;
  guardar.innerText = "üíæ Guardar poste";
}

// ================= NUEVO POSTE (INSTANT√ÅNEO) =================
function nuevoPoste() {
  poste.value = "";
  foto1.value = "";
  foto2.value = "";
  foto3.value = "";
  poste.focus();
}
</script>

</body>
</html>
