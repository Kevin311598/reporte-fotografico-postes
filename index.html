<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Reporte Fotogr√°fico Postes</title>

<style>
body {
  font-family: Arial, sans-serif;
  padding: 15px;
  background: #f4f4f4;
}
input, button {
  width: 100%;
  margin: 8px 0;
  padding: 12px;
  font-size: 16px;
}
label {
  font-weight: bold;
}
button {
  border: none;
  border-radius: 6px;
}
#guardar {
  background: #2e7d32;
  color: white;
}
#nuevo {
  background: #0277bd;
  color: white;
}
.info {
  font-weight: bold;
  margin: 6px 0;
}
</style>
</head>

<body>

<h2>üì∏ Reporte Fotogr√°fico</h2>

<p class="info" id="fecha"></p>
<p class="info" id="gps">üìç Obteniendo GPS‚Ä¶</p>

<input id="proyecto" placeholder="Proyecto" required>
<input id="poste" placeholder="N√∫mero de poste" required>

<label>1Ô∏è‚É£ N√∫mero de poste</label>
<input type="file" id="foto1" accept="image/*" capture="camera">

<label>2Ô∏è‚É£ Ferreter√≠a del poste</label>
<input type="file" id="foto2" accept="image/*" capture="camera">

<label>3Ô∏è‚É£ Vista panor√°mica</label>
<input type="file" id="foto3" accept="image/*" capture="camera">

<button id="guardar" onclick="enviar()">üíæ Guardar poste</button>
<button id="nuevo" onclick="nuevoPoste()">‚ûï Agregar otro poste</button>

<script>
// ================= CONFIG =================
const URL_BACKEND = "PEGA_AQUI_TU_URL_DE_APPS_SCRIPT";

// ================= FECHA =================
const fechaHoy = new Date().toISOString().slice(0,10);
document.getElementById("fecha").innerText = "üìÖ Fecha: " + fechaHoy;

// ================= GPS =================
let coords = { lat: "", lon: "" };

function obtenerGPS() {
  navigator.geolocation.getCurrentPosition(
    pos => {
      coords.lat = pos.coords.latitude.toFixed(6);
      coords.lon = pos.coords.longitude.toFixed(6);
      document.getElementById("gps").innerText =
        `üìç GPS: ${coords.lat}, ${coords.lon}`;
    },
    () => {
      document.getElementById("gps").innerText =
        "‚ùå GPS no disponible";
    },
    { enableHighAccuracy: true }
  );
}
obtenerGPS();

// ================= MARCA DE AGUA =================
function procesarImagen(file, texto) {
  return new Promise(resolve => {
    const img = new Image();
    const reader = new FileReader();

    reader.onload = e => img.src = e.target.result;

    img.onload = () => {
      const MAX = 1600;
      let w = img.width;
      let h = img.height;

      if (w > MAX) {
        h *= MAX / w;
        w = MAX;
      }

      const canvas = document.createElement("canvas");
      canvas.width = w;
      canvas.height = h;
      const ctx = canvas.getContext("2d");

      ctx.drawImage(img, 0, 0, w, h);

      // Fondo para texto
      ctx.fillStyle = "rgba(0,0,0,0.6)";
      ctx.fillRect(0, h - 160, w, 160);

      // Texto
      ctx.fillStyle = "white";
      ctx.font = "bold 36px Arial";
      ctx.fillText(`Fecha: ${fechaHoy}`, 20, h - 110);
      ctx.fillText(`Poste: ${document.getElementById("poste").value}`, 20, h - 70);
      ctx.fillText(`GPS: ${coords.lat}, ${coords.lon}`, 20, h - 30);

      canvas.toBlob(blob => {
        const r2 = new FileReader();
        r2.onloadend = () =>
          resolve(r2.result.split(",")[1]);
        r2.readAsDataURL(blob);
      }, "image/jpeg", 0.9);
    };

    reader.readAsDataURL(file);
  });
}

// ================= ENVIAR =================
async function enviar() {
  if (!coords.lat) {
    alert("Espera a que el GPS cargue");
    return;
  }

  const proyecto = proyectoInput.value;
  const poste = posteInput.value;

  const f1 = foto1.files[0];
  const f2 = foto2.files[0];
  const f3 = foto3.files[0];

  if (!proyecto || !poste || !f1 || !f2 || !f3) {
    alert("Completa todos los campos y fotos");
    return;
  }

  guardar.disabled = true;
  guardar.innerText = "Subiendo...";

  const foto1b = await procesarImagen(f1);
  const foto2b = await procesarImagen(f2);
  const foto3b = await procesarImagen(f3);

  await fetch(URL_BACKEND, {
    method: "POST",
    body: JSON.stringify({
      proyecto,
      poste,
      lat: coords.lat,
      lon: coords.lon,
      foto1: foto1b,
      foto2: foto2b,
      foto3: foto3b
    })
  });

  alert("‚úÖ Poste guardado correctamente");

  guardar.disabled = false;
  guardar.innerText = "üíæ Guardar poste";
}

// ================= NUEVO POSTE =================
function nuevoPoste() {
  posteInput.value = "";
  foto1.value = "";
  foto2.value = "";
  foto3.value = "";
  obtenerGPS();
}
</script>

</body>
</html>
